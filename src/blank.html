<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>
      Process | SwaPro
    </title>
  </head>
  <body
    x-data="{
      page: 'blank',
      'loaded': true,
      'darkMode': false,
      'stickyMenu': false,
      'sidebarToggle': false,
      'scrollTop': false,
      'generating': false,
      'selectedCountry': '',
      'selectedModel': '',
      completedSteps: 0,
      imagePreviews: [],
      updateProgress() {
        this.completedSteps = 0;
        if (this.imagePreviews.length > 0) this.completedSteps++;
        if (this.selectedCountry) this.completedSteps++;
        if (this.selectedModel) this.completedSteps++;
      },
      handleFiles(files) {
        this.imagePreviews = [];
        Array.from(files).forEach(file => {
          const reader = new FileReader();
          reader.onload = (e) => {
            this.imagePreviews.push(e.target.result);
            this.updateProgress();
          };
          reader.readAsDataURL(file);
        });
      },
      removeImage(index) {
        this.imagePreviews.splice(index, 1);
        this.updateProgress();
      },
      async processImages() {
        if (this.imagePreviews.length === 0) return;
        this.generating = true;
        try {
          const response = await fetch('http://localhost:5000/process-image', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              images: this.imagePreviews,
              country: this.selectedCountry,
              model: this.selectedModel
            })
          });
        
          const results = await response.json();
          
          // Handle results
          results.forEach((result, index) => {
            if (result.success) {
              // Update the preview with the processed image
              this.imagePreviews[index] = 'data:image/jpeg;base64,' + result.result;
              
              // Save processed image to localStorage
              const processedImages = JSON.parse(localStorage.getItem('processedImages') || '[]');
              processedImages.push({
                url: 'data:image/jpeg;base64,' + result.result,
                date: new Date().toLocaleString(),
                country: this.selectedCountry,
                model: this.selectedModel
              });
              localStorage.setItem('processedImages', JSON.stringify(processedImages));

              // Save weather style transfer images to localStorage (append all effects)
              if (result.weather_results && result.weather_results.effects) {
                let weatherImages = [];
                try {
                  weatherImages = JSON.parse(localStorage.getItem('weatherImages') || '[]');
                } catch (e) {
                  weatherImages = [];
                }
                const newWeatherImages = Object.entries(result.weather_results.effects).map(([effect, url]) => ({
                  url,
                  effect
                }));
                // Append new images, avoid duplicates
                newWeatherImages.forEach(newImg => {
                  if (!weatherImages.some(img => img.url === newImg.url)) {
                    weatherImages.push(newImg);
                  }
                });
                localStorage.setItem('weatherImages', JSON.stringify(weatherImages));
              }
            } else {
              alert(`Error processing image ${index + 1}: ${result.error}`);
            }
          });
          
          // Show success message
          alert('Images processed successfully!');
          
          // Redirect to signin.html
          window.location.href = 'index.html';
          
          // After processing, fetch all images in weather_style_results and update the Weather Style Transfer Results table
          fetch('/list-weather-style-results')
            .then(response => response.json())
            .then(files => {
              let weatherImages = [];
              try {
                weatherImages = JSON.parse(localStorage.getItem('weatherImages') || '[]');
              } catch (e) {
                weatherImages = [];
              }
              files.forEach(file => {
                // Only add image files
                if (file.match(/\.(jpg|jpeg|png|gif)$/i)) {
                  const url = '/weather_style_results/' + file;
                  if (!weatherImages.some(img => img.url === url)) {
                    weatherImages.push({ url, effect: file.replace('_effect.jpg', '').replace('.jpg', '') });
                  }
                }
              });
              localStorage.setItem('weatherImages', JSON.stringify(weatherImages));
            });
          
        } catch (error) {
          console.error('Error:', error);
          alert('Error processing images: ' + error);
        } finally {
          this.generating = false;
        }
      },
      ...imageUpload()
    }"
    x-init="
         darkMode = JSON.parse(localStorage.getItem('darkMode'));
         $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark bg-gray-900': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div
        class="relative flex flex-col flex-1 overflow-x-hidden overflow-y-auto"
      >
        <!-- Small Device Overlay Start -->
        <include src="./partials/overlay.html" />
        <!-- Small Device Overlay End -->

        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <!-- Loading Overlay -->
          <div x-show="generating" class="fixed inset-0 z-50 flex items-center justify-center bg-white bg-opacity-70 backdrop-blur-sm">
            <div class="flex flex-col items-center">
              <svg class="animate-spin h-12 w-12 text-blue-600 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span class="text-blue-700 text-lg font-semibold">Loading...</span>
            </div>
          </div>
          <!-- Loading Overlay End -->
          <div class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6">
            <!-- Progress Bar Start -->
            <div class="mb-8">
              <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-black dark:text-white">Process Progress</h2>
                <div class="text-sm text-gray-500 dark:text-gray-400">
                  <span x-text="completedSteps + '/3'"></span> Steps Completed
                </div>
              </div>
              <div class="relative">
                <!-- Progress Bar -->
                <div class="h-2 bg-gray-200 rounded-full dark:bg-gray-700">
                  <div class="h-2 bg-green-500 rounded-full transition-all duration-500"
                       :style="'width: ' + (completedSteps * 33.33) + '%'"></div>
                </div>
                
                <!-- Steps -->
                <div class="flex justify-between mt-4">
                  <!-- Step 1 -->
                  <div class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                         :class="completedSteps >= 1 ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-500'">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                    </div>
                    <span class="mt-2 text-sm font-medium" :class="completedSteps >= 1 ? 'text-green-500' : 'text-gray-500'">Upload Image</span>
                  </div>
                  
                  <!-- Step 2 -->
                  <div class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                         :class="completedSteps >= 2 ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-500'">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                      </svg>
                    </div>
                    <span class="mt-2 text-sm font-medium" :class="completedSteps >= 2 ? 'text-green-500' : 'text-gray-500'">Select Country</span>
                  </div>
                  
                  <!-- Step 3 -->
                  <div class="flex flex-col items-center">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                         :class="completedSteps >= 3 ? 'bg-green-500 text-white' : 'bg-gray-200 dark:bg-gray-700 text-gray-500'">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                      </svg>
                    </div>
                    <span class="mt-2 text-sm font-medium" :class="completedSteps >= 3 ? 'text-green-500' : 'text-gray-500'">Choose Model</span>
                  </div>
                </div>
              </div>
            </div>
            <!-- Progress Bar End -->

            <div class="grid grid-cols-12 gap-4 md:gap-6">
              <!-- Cards Container -->
              <div class="col-span-12 grid grid-cols-12 gap-4 md:gap-6">
                <!-- New Image Upload Card -->
                <div class="col-span-12">
                  <div class="rounded-sm border border-stroke bg-white px-5 pt-7.5 pb-5 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5">
                    <div class="flex flex-wrap items-start justify-between gap-3 sm:flex-nowrap">
                      <div class="flex w-full flex-wrap gap-3 sm:gap-5">
                        <div class="flex min-w-47.5">
                          <span class="mt-1 mr-2 flex h-4 w-full max-w-4 items-center justify-center rounded-full border border-primary">
                            <span class="block h-2.5 w-full max-w-2.5 rounded-full bg-primary"></span>
                          </span>
                          <div class="w-full">
                            <p class="font-semibold text-primary">Image Upload</p>
                            <p class="text-sm font-medium">Upload your images here</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="mt-4">
                      <div class="flex flex-col items-center justify-center w-full">
                        <!-- Upload Area -->
                        <label
                          x-show="!imagePreviews.length"
                          for="dropzone-file"
                          class="flex flex-col items-center justify-center w-full h-64 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 dark:hover:bg-gray-800 dark:bg-gray-700 hover:bg-gray-100 dark:border-gray-600 dark:hover:border-gray-500 dark:hover:bg-gray-600"
                          @dragover.prevent
                          @drop.prevent="
                            const files = $event.dataTransfer.files;
                            if (files.length > 5) {
                              alert('Please select maximum 5 images');
                              return;
                            }
                            handleFiles(files);
                          "
                        >
                          <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                            </svg>
                            <p class="mb-2 text-sm text-gray-500 dark:text-gray-400"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">Upload up to 5 images (SVG, PNG, JPG or GIF)</p>
                          </div>
                          <input 
                            id="dropzone-file" 
                            type="file" 
                            class="hidden" 
                            accept="image/*" 
                            multiple
                            @change="
                              const files = $event.target.files;
                              if (files.length > 5) {
                                alert('Please select maximum 5 images');
                                $event.target.value = '';
                                return;
                              }
                              handleFiles(files);
                            "
                          />
                        </label>

                        <!-- Image Previews -->
                        <div x-show="imagePreviews.length > 0" class="grid grid-cols-2 gap-4 w-full mt-4">
                          <template x-for="(preview, index) in imagePreviews" :key="index">
                            <div class="relative">
                              <img :src="preview" class="w-full h-48 object-contain rounded-lg" :alt="'Preview ' + (index + 1)" />
                              <button 
                                @click="imagePreviews.splice(index, 1); updateProgress()"
                                class="absolute top-2 right-2 px-3 py-1.5 text-sm font-medium text-white bg-red-500 rounded-lg hover:bg-red-600"
                              >
                                Remove
                              </button>
                            </div>
                          </template>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- New Image Upload Card End -->

                <!-- Country Selection Card -->
                <div class="col-span-12 xl:col-span-6">
                  <div class="rounded-sm border border-stroke bg-white px-5 pt-7.5 pb-5 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 h-full">
                    <div class="flex flex-wrap items-start justify-between gap-3 sm:flex-nowrap">
                      <div class="flex w-full flex-wrap gap-3 sm:gap-5">
                        <div class="flex min-w-47.5">
                          <span class="mt-1 mr-2 flex h-4 w-full max-w-4 items-center justify-center rounded-full border border-primary">
                            <span class="block h-2.5 w-full max-w-2.5 rounded-full bg-primary"></span>
                          </span>
                          <div class="w-full">
                            <p class="font-semibold text-primary">Country Selection</p>
                            <p class="text-sm font-medium">Choose the country of the Synthesized plates</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="mt-4">
                      <div class="relative z-20 bg-transparent dark:bg-form-input">
                        <select
                          x-model="selectedCountry"
                          @change="updateProgress()"
                          class="w-full rounded-lg border-[1.5px] border-stroke bg-transparent px-5 py-3 text-black outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-gray-2 dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-primary"
                        >
                          <option value="">Select Country</option>
                          <option value="IT">Italy</option>
                          <option value="DE-BER">Berlin - Germany</option>
                          <option value="DE-BAY">Bayern - Germany</option>
                          <option value="EG">Egypt</option>
                          <option value="IR">Iran</option>
                          <option value="IQ">Iraq</option>
                          <option value="QA">Qatar</option>
                        </select>
                        <span class="absolute top-1/2 right-4 z-30 -translate-y-1/2">
                            <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <g opacity="0.8">
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M5.29289 8.29289C5.68342 7.90237 6.31658 7.90237 6.70711 8.29289L12 13.5858L17.2929 8.29289C17.6834 7.90237 18.3166 7.90237 18.7071 8.29289C19.0976 8.68342 19.0976 9.31658 18.7071 9.70711L12.7071 15.7071C12.3166 16.0976 11.6834 16.0976 11.2929 15.7071L5.29289 9.70711C4.90237 9.31658 4.90237 8.68342 5.29289 8.29289Z" fill=""></path>
                                </g>
                            </svg>
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Country Selection Card End -->

                <!-- Training Data Card -->
                <div class="col-span-12 xl:col-span-6">
                  <div class="rounded-sm border border-stroke bg-white px-5 pt-7.5 pb-5 shadow-default dark:border-strokedark dark:bg-boxdark sm:px-7.5 h-full">
                    <div class="flex flex-wrap items-start justify-between gap-3 sm:flex-nowrap">
                      <div class="flex w-full flex-wrap gap-3 sm:gap-5">
                        <div class="flex min-w-47.5">
                          <span class="mt-1 mr-2 flex h-4 w-full max-w-4 items-center justify-center rounded-full border border-primary">
                            <span class="block h-2.5 w-full max-w-2.5 rounded-full bg-primary"></span>
                          </span>
                          <div class="w-full">
                            <p class="font-semibold text-primary">Training Data</p>
                            <p class="text-sm font-medium">Select a model to train data on</p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="mt-4 space-y-4">
                      <!-- Model Selection -->
                      <div class="relative z-20 bg-transparent dark:bg-form-input">
                        <label class="mb-2.5 block text-black dark:text-white">
                          Select Model
                        </label>
                        <select
                          x-model="selectedModel"
                          @change="updateProgress()"
                          class="w-full rounded-lg border-[1.5px] border-stroke bg-transparent px-5 py-3 text-black outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-gray-2 dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-primary"
                        >
                          <option value="">Choose Model</option>
                          <option value="vehicle">Vehicle Detection</option>
                          <option value="license">License Plate Detection</option>
                          <option value="ocr">OCR (Text Recognition)</option>
                          <option value="face">Face Detection</option>
                          <option value="object">Object Detection</option>
                          <option value="custom">Custom Model</option>
                        </select>
                        <span class="absolute top-1/2 right-4 z-30 -translate-y-1/2">
                          <svg class="fill-current" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g opacity="0.8">
                              <path fill-rule="evenodd" clip-rule="evenodd" d="M5.29289 8.29289C5.68342 7.90237 6.31658 7.90237 6.70711 8.29289L12 13.5858L17.2929 8.29289C17.6834 7.90237 18.3166 7.90237 18.7071 8.29289C19.0976 8.68342 19.0976 9.31658 18.7071 9.70711L12.7071 15.7071C12.3166 16.0976 11.6834 16.0976 11.2929 15.7071L5.29289 9.70711C4.90237 9.31658 4.90237 8.68342 5.29289 8.29289Z" fill=""></path>
                            </g>
                          </svg>
                        </span>
                      </div>

                      <!-- Model Description -->
                      <div class="mt-4">
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                          <span x-show="selectedModel === 'vehicle'">Vehicle Detection: Detects and classifies different types of vehicles in images and videos.</span>
                          <span x-show="selectedModel === 'license'">License Plate Detection: Identifies and extracts license plate information from images.</span>
                          <span x-show="selectedModel === 'ocr'">OCR: Extracts text from images and documents with high accuracy.</span>
                          <span x-show="selectedModel === 'face'">Face Detection: Detects and analyzes human faces in images and videos.</span>
                          <span x-show="selectedModel === 'object'">Object Detection: Identifies and locates multiple objects within an image.</span>
                          <span x-show="selectedModel === 'custom'">Custom Model: Train a model according to your specific requirements.</span>
                        </p>
                      </div>

                      <!-- Start Training Button -->
                      <div class="mt-6">
                        <button @click="startTraining" class="flex w-full justify-center rounded bg-primary p-3 font-medium text-white hover:bg-opacity-90">
                          Start Training
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Training Data Card End -->
              </div>
              <!-- Cards Container End -->

              <!-- Synthesize Button -->
              <div class="col-span-12 flex justify-center mt-8">
                <button
                  @click="
                    if (imagePreviews.length === 0) {
                      alert('Please upload images first');
                      return;
                    }
                    if (!selectedCountry) {
                      alert('Please select a country');
                      return;
                    }
                    if (!selectedModel) {
                      alert('Please select a model');
                      return;
                    }
                    generating = true;
                    processImages();
                  "
                  class="inline-flex items-center justify-center rounded-md bg-green-500 py-4 px-10 text-center font-medium text-white hover:bg-green-600 lg:px-8 xl:px-10"
                >
                  <span x-show="!generating">Synthesize</span>
                  <span x-show="generating">Processing...</span>
                </button>
              </div>
              <!-- Synthesize Button End -->
            </div>
          </div>
        </main>
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <script>
      document.addEventListener('alpine:init', () => {
        Alpine.data('imageUpload', () => ({
          imagePreview: null,
          handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (e) => {
                this.imagePreview = e.target.result;
              };
              reader.readAsDataURL(file);
            }
          },
          removeImage() {
            this.imagePreview = null;
            document.getElementById('dropzone-file').value = '';
          }
        }));
      });

      async function synthesize() {
        console.log('Synthesize function called');
        
        // Get processed images from local storage
        const processedImages = JSON.parse(localStorage.getItem('processedImages') || '[]');
        console.log('Processed images from storage:', processedImages);
        
        if (processedImages.length === 0) {
          alert('Please process an image first.');
          return;
        }

        // Get the last processed image (the one just added to the table)
        const latestImage = processedImages[processedImages.length - 1].url;
        console.log('Latest image URL:', latestImage.substring(0, 50) + '...');

        // Save to database as avatar
        const token = localStorage.getItem('token');
        console.log('Token exists:', !!token);
        
        if (token) {
          try {
            console.log('Sending image to server...');
            const response = await fetch('http://localhost:5001/save-processed-image', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({
                imageData: latestImage
              })
            });

            if (!response.ok) {
              throw new Error('Failed to save image');
            }

            const result = await response.json();
            console.log('Server response:', result);
            alert('Image saved successfully as avatar!');
          } catch (error) {
            console.error('Error saving image:', error);
            alert('Error saving image: ' + error.message);
          }
        } else {
          console.error('No authentication token found');
          alert('Please login first');
        }
      }

      // Make sure the button click handler is properly set up
      document.addEventListener('DOMContentLoaded', function() {
        const synthesizeBtn = document.getElementById('synthesizeBtn');
        if (synthesizeBtn) {
          console.log('Synthesize button found');
          synthesizeBtn.addEventListener('click', function() {
            console.log('Synthesize button clicked');
            synthesize();
          });
        } else {
          console.error('Synthesize button not found');
        }
      });

      // Add a function to save table image to user document
      async function saveTableImageToUser() {
        const token = localStorage.getItem('token');
        if (!token) {
          alert('Please sign in to save your processed images to your account');
          return;
        }

        // Get the latest image from the table
        const processedImages = JSON.parse(localStorage.getItem('processedImages') || '[]');
        if (processedImages.length === 0) {
          alert('No images in the table to save');
          return;
        }

        // Get the latest image
        const latestImage = processedImages[processedImages.length - 1].url;
        console.log('Saving latest table image to user document...');

        try {
          const response = await fetch('http://localhost:5001/save-processed-image', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
              imageData: latestImage
            })
          });

          if (!response.ok) {
            throw new Error('Failed to save image');
          }

          const result = await response.json();
          console.log('Save result:', result);
          alert('Image saved successfully to your account!');
        } catch (error) {
          console.error('Error saving image:', error);
          alert('Error saving image: ' + error.message);
        }
      }

      // Add a button to save table image to user document
      document.addEventListener('DOMContentLoaded', function() {
        const tableContainer = document.querySelector('.table-container');
        if (tableContainer) {
          const saveButton = document.createElement('button');
          saveButton.className = 'inline-flex items-center justify-center rounded-md bg-primary py-2 px-4 text-center font-medium text-white hover:bg-opacity-90';
          saveButton.textContent = 'Save Latest Image to Account';
          saveButton.onclick = saveTableImageToUser;
          tableContainer.insertBefore(saveButton, tableContainer.firstChild);
        }
      });

      // Function to fetch and display user profile
      async function fetchUserProfile() {
        const token = localStorage.getItem('token');
        if (!token) return;

        try {
          const response = await fetch('http://localhost:5001/user/profile', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          if (!response.ok) {
            throw new Error('Failed to fetch profile');
          }

          const userData = await response.json();
          console.log('User profile:', userData);

          // Update profile information in the UI
          const profileName = document.querySelector('.profile-name');
          const profileEmail = document.querySelector('.profile-email');
          const profileImage = document.querySelector('.profile-image');

          if (profileName) profileName.textContent = userData.username;
          if (profileEmail) profileEmail.textContent = userData.email;
          
          // Update profile image if avatar exists
          if (profileImage && userData.avatar && userData.avatar.data && userData.avatar.data.$binary && userData.avatar.data.$binary.base64) {
            profileImage.src = `data:image/jpeg;base64,${userData.avatar.data.$binary.base64}`;
          }

          // Store user data in localStorage for other components
          localStorage.setItem('userProfile', JSON.stringify(userData));
        } catch (error) {
          console.error('Error fetching user profile:', error);
        }
      }

      // Call fetchUserProfile when the page loads
      document.addEventListener('DOMContentLoaded', function() {
        fetchUserProfile();
      });

      // Update the login success handler to fetch profile
      function handleLoginSuccess(token) {
        localStorage.setItem('token', token);
        fetchUserProfile(); // Fetch profile after successful login
        window.location.href = 'index.html';
      }
    </script>
  </body>
</html>
